<% if (needsDatabase) { %>import { PrismaClient } from '@prisma/client';

const prismaClientSingleton = () => {
  return new PrismaClient({
    log: process.env.NODE_ENV === 'development' ? ['query'] : [],
  }).$extends({
    query: {
      async $allOperations({ args, query }) {
        const maxRetries = 3;
        let lastError: unknown;

        for (let attempt = 0; attempt < maxRetries; attempt++) {
          try {
            return await query(args);
          } catch (e) {
            lastError = e;
            if (e instanceof Error && e.message.includes('connect')) {
              await new Promise((r) => setTimeout(r, 100 * (attempt + 1)));
              continue;
            }
            throw e;
          }
        }
        throw lastError;
      },
    },
  });
};

declare const globalThis: {
  prismaGlobal: ReturnType<typeof prismaClientSingleton>;
} & typeof global;

const prisma = globalThis.prismaGlobal ?? prismaClientSingleton();

if (process.env.NODE_ENV !== 'production') {
  globalThis.prismaGlobal = prisma;
}

export { prisma };
<% } else { %>// Database not configured for this project
export {};
<% } %>

import { NextResponse } from 'next/server';
<% if (needsDatabase) { %>import { prisma } from '@/lib/prisma';<% } %>

export async function GET() {
  const startTime = Date.now();

<% if (needsDatabase) { %>
  let dbStatus = 'pass';
  let dbLatency = 0;
  try {
    const dbStart = Date.now();
    await prisma.$queryRaw`SELECT 1`;
    dbLatency = Date.now() - dbStart;
  } catch {
    dbStatus = 'fail';
  }
<% } %>

  const memUsage = process.memoryUsage();
  const memUsedMB = Math.round(memUsage.heapUsed / 1024 / 1024);
  const memTotalMB = Math.round(memUsage.heapTotal / 1024 / 1024);

  const responseTime = Date.now() - startTime;
<% if (needsDatabase) { %>
  const allHealthy = dbStatus === 'pass';
<% } else { %>
  const allHealthy = true;
<% } %>

  return NextResponse.json({
    status: allHealthy ? 'healthy' : 'degraded',
    timestamp: new Date().toISOString(),
    uptime: Math.floor(process.uptime()),
    version: process.env.npm_package_version || '0.1.0',
    responseTimeMs: responseTime,
    checks: {
<% if (needsDatabase) { %>
      database: {
        status: dbStatus,
        latencyMs: dbLatency,
      },
<% } %>
      memory: {
        usedMB: memUsedMB,
        totalMB: memTotalMB,
        percentUsed: Math.round((memUsedMB / memTotalMB) * 100),
      },
    },
  });
}
